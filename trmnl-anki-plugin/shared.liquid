<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
{% assign anki_id = "anki-" | append_random %}
<style>
  #{{ anki_id }} .content > :first-child {
    font-size: 1.5rem;
    line-height: 1.5rem;
  }
</style>

<div id="{{ anki_id }}">
  <div class="layout">
    <div class="richtext richtext--center gap--large">
      <div data-content-limiter="true" class="markdown content content--center gap text--center pt--1">
      </div>
    </div>
  </div>
  
  <div class="title_bar">
    <img class="image" src="https://usetrmnl.com/images/plugins/trmnl--render.svg">
    <span class="title">{{ trmnl.plugin_settings.instance_name }}</span>
    <span class="instance">Created on: {{ note_id | divided_by: 1000 | plus: trmnl.user.utc_offset | date: '%b %d, %Y' }}</span>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function(e) { 
    // Yoinked from https://github.com/albert7617/trmnl-japanese
    function decompressText(compressedText) {
      // Decode the base64 string to binary data
      const binaryString = atob(compressedText);

      // Convert the binary string to a Uint8Array
      const bytes = new Uint8Array(binaryString.length);
      for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }

      // Decompress using zlib (pako is a popular zlib library for browsers)
      // Note: You'll need to include pako.js for this to work
      const decompressedBytes = pako.inflate(bytes);

      // Convert the decompressed bytes back to a string
      const decoder = new TextDecoder('utf-8');
      return decoder.decode(decompressedBytes);
    }

    function populate(data, instance) {
      const decompressedData = JSON.parse(decompressText(data));
      console.log(JSON.stringify(decompressedData));
      const instanceDiv = document.getElementById(instance)
      const mainContainer = instanceDiv.querySelector(`.content`);
      Object.entries(decompressedData).forEach(([key, value]) => {
        if (!value) {
          return;
        }
        console.log(`${key} ${value}`);
        const el = document.createElement("span");
        // We intentionally don't escape the value since anki fields can contain styled HTML
        el.innerHTML = value;
        mainContainer.appendChild(el);
      });
      mainContainer.firstElementChild?.setAttribute("data-value-fit", "true");
      mainContainer.firstElementChild?.setAttribute("data-value-fit-max-height", "340");

      const noteTimestamp = instanceDiv.querySelector(`.note-id`);
    }
    populate("{{ compressed }}", "{{ anki_id }}");
  });
</script>
